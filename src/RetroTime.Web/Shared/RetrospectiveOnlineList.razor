@implements IRetrospectiveJoinedSubscriber
@inherits SubscribingComponent<IRetrospectiveJoinedSubscriber>
@using RetroTime.Application.Notifications.RetrospectiveJoined

@using System.Diagnostics
@using RetroTime.Application.Common.Models
@using RetroTime.Application.Notifications
@using RetroTime.Application.Retrospectives.Queries.GetParticipantsInfo

@if (Participants == null)
{
    return;
}

<article class="card" id="retrospective-online-list">
    <div class="card-header bg-dark text-light">
        Who already joined?
    </div>
    <div class="card-body p-2">
        @if (Participants.Participants.Count == 0)
        {
            <text>No one. You are the first to join this retrospective.</text>
        }
        else if (Participants.Participants.Count == 1)
        {
            ParticipantInfo participant = Participants.Participants[0];

            <text>@RenderParticipant(participant) has already joined the retrospective</text>
        }
        else
        {
            <text>
                These people have already joined the retrospective:
            </text>

            <ul class="online-list">
                @foreach (ParticipantInfo participant in Participants.Participants)
                {
                    <li class="@(participant.Name == CurrentParticipant.Name ? "online-list__item--is-self" : null)">
                        @RenderParticipant(participant)
                    </li>
                }
            </ul>
        }
    </div>
</article>

@code {
#nullable disable

    protected override async Task OnInitializedAsync()
    {
        Participants = await Mediator.Send(new GetParticipantsInfoQuery(RetroId));
        Debug.Assert(Participants != null);
    }

    protected readonly RenderFragment<ParticipantInfo> RenderParticipant = participantInfo =>
        @<span style="color: #@participantInfo.Color.HexString" data-participant-id="@participantInfo.Id">
            @if (participantInfo.IsFacilitator) { <span class="fas fa-crown me-1"></span> }
            @participantInfo.Name
         </span>;

    #nullable disable

    public ParticipantsInfoList Participants { get; set; }

    [Parameter]
    public string RetroId { get; set; }

    [Parameter]
    public CurrentParticipantModel CurrentParticipant { get; set; }

    public Task OnParticipantJoinedRetrospective(RetrospectiveEvent<ParticipantInfo> eventArgs)
    {
        if (eventArgs.RetroId != RetroId)
        {
            return Task.CompletedTask;
        }

        ParticipantInfo participantInfo = eventArgs.Argument;

        return InvokeAsync(() =>
        {
            Participants.Participants.Add(participantInfo);
            Participants.Participants.Sort((a, b) => StringComparer.CurrentCulture.Compare(a.Name, b.Name));

            NotificationIsHandled();
        });
    }

}
